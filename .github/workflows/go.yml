- name: Build and push Docker image
  uses: docker/build-push-action@v5
  with:
    context: .
    push: true
    tags: ${{ env.DOCKER_IMAGE }}:latest
    build-args: |
      JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
      AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}
      AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}

- name: Deploy to EC2
  uses: appleboy/ssh-action@master
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ubuntu
    key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
    script: |
      echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" > .env
      echo "AWS_ACCESS_KEY=${{ secrets.AWS_ACCESS_KEY }}" >> .env
      echo "AWS_SECRET_KEY=${{ secrets.AWS_SECRET_KEY }}" >> .env
      
      docker pull ${{ env.DOCKER_IMAGE }}:latest
      docker stop tickit-server-container || true
      docker rm tickit-server-container || true
      docker run -d --name tickit-server-container \
        -p 7000:7000 \
        --env-file .env \
        ${{ env.DOCKER_IMAGE }}:latest
